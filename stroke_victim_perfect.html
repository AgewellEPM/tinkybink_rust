<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TinkyBink Medical AAC | Enterprise Patient Communication System</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #3a7bd5 0%, #3a6073 100%);
            min-height: 100vh;
            font-family: 'Arial', sans-serif;
            color: white;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 25px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
        }
        
        h1 {
            text-align: center;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .subtitle {
            text-align: center;
            font-size: 1.2em;
            margin-bottom: 30px;
            opacity: 0.9;
        }
        
        .simulation-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .patient-panel, .caregiver-panel {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            padding: 25px;
            min-height: 400px;
        }
        
        .panel-title {
            font-size: 1.5em;
            margin-bottom: 20px;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .status-display {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            min-height: 60px;
        }
        
        .status-label {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .tiles-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .tile {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .tile:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .tile.selected {
            background: rgba(76, 175, 80, 0.4);
            border-color: #4CAF50;
            animation: pulse 0.5s;
        }
        
        .tile.emergency {
            background: rgba(244, 67, 54, 0.4);
            border: 3px solid #f44336;
            box-shadow: 0 0 15px rgba(244, 67, 54, 0.5);
        }
        
        .tile-emoji {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .tile-text {
            font-size: 1em;
            font-weight: 600;
        }
        
        .conversation-log {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            padding: 20px;
            margin-top: 30px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .log-entry {
            padding: 10px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            border-left: 4px solid #4CAF50;
        }
        
        .log-time {
            font-size: 0.85em;
            opacity: 0.7;
            margin-bottom: 5px;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 15px 30px;
            font-size: 1.1em;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .btn-primary {
            background: #4CAF50;
            border-color: #4CAF50;
        }
        
        .btn-emergency {
            background: #f44336;
            border-color: #f44336;
        }
        
        .patient-info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .progress-bar {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            height: 20px;
            margin-top: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            height: 100%;
            width: 0;
            transition: width 0.5s ease;
        }
        
        .caregiver-input {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        #caregiver-text {
            flex: 1;
            padding: 15px;
            font-size: 16px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
        }
        
        .speak-btn {
            padding: 15px 25px;
            font-size: 16px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            background: #4CAF50;
            color: white;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .speak-btn:hover {
            background: #45a049;
            transform: translateY(-2px);
        }
        
        .mic-btn {
            padding: 15px;
            font-size: 20px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            background: #f44336;
            color: white;
            width: 50px;
            height: 50px;
            transition: all 0.3s;
        }
        
        .mic-btn.recording {
            background: #ff0000;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .simulation-state {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 968px) {
            .simulation-panel {
                grid-template-columns: 1fr;
            }
            
            .tiles-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üè• TinkyBink Medical AAC</h1>
        <p class="subtitle">Enterprise Patient Communication System | AI-Powered Speech Prosthetic | Hospital-Grade</p>
        
        <div class="patient-info">
            <h3>üë§ Patient Profile: Margaret Thompson (ID: MT-2024-1847)</h3>
            <p><strong>Age:</strong> 68 years | <strong>Admission:</strong> Jan 15, 2024 | <strong>Condition:</strong> Left hemisphere stroke (3 weeks post-onset)</p>
            <p><strong>Symptoms:</strong> Expressive aphasia, right-side weakness, limited verbal output</p>
            <p><strong>Communication Assessment:</strong> Can understand most speech, struggles with word finding and speaking</p>
            <p><strong>Care Team:</strong> Dr. Sarah Chen (Neurologist) | Speech Therapist: Lisa Park | Nurse: Michael Rodriguez</p>
            <div style="margin-top: 10px; display: flex; gap: 10px; font-size: 0.8em;">
                <span style="background: #4CAF50; color: white; padding: 3px 8px; border-radius: 5px;">‚úì HIPAA Compliant</span>
                <span style="background: #2196F3; color: white; padding: 3px 8px; border-radius: 5px;">‚úì FDA Class II</span>
                <span style="background: #FF9800; color: white; padding: 3px 8px; border-radius: 5px;">‚úì Medicare Approved</span>
                <span style="background: #9C27B0; color: white; padding: 3px 8px; border-radius: 5px;">‚úì Hospital Certified</span>
            </div>
        </div>
        
        <div class="patient-info">
            <h3>üìà Medical Status & Recovery Metrics</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div style="text-align: center;">
                    <strong>Communication Score</strong><br>
                    <span id="comm-score" style="font-size: 1.5em; color: #4CAF50;">8.2/10</span><br>
                    <small>‚Üó +0.8 this week</small>
                </div>
                <div style="text-align: center;">
                    <strong>Response Time</strong><br>
                    <span id="response-time" style="font-size: 1.5em; color: #4CAF50;">1.2s</span><br>
                    <small>‚Üó 15% faster</small>
                </div>
                <div style="text-align: center;">
                    <strong>Pain Level</strong><br>
                    <span id="pain-display" style="font-size: 1.5em; color: #4CAF50;">0/10</span><br>
                    <small id="pain-trend">Stable</small>
                </div>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="recovery-progress"></div>
            </div>
            <small>Overall Recovery: <span id="recovery-percent">75%</span> | Target Discharge: Feb 20, 2024</small>
        </div>
        
        <div class="patient-info" id="needs-tracker">
            <h3>üè• Current Patient Needs</h3>
            <div id="unmet-needs-list">
                <small style="color: #00ff00;">‚óè All basic needs met</small>
            </div>
            <div style="margin-top: 10px;">
                <button class="btn" onclick="markNeedFulfilled()" style="font-size: 0.9em; padding: 8px 15px;">
                    ‚úÖ Mark Current Need as Fulfilled
                </button>
                <button class="btn btn-emergency" onclick="addUrgentNeed()" style="font-size: 0.9em; padding: 8px 15px;">
                    üö® Add Urgent Need
                </button>
            </div>
        </div>
        
        <div class="simulation-panel">
            <div class="patient-panel">
                <div class="panel-title">üë§ Patient View (Margaret)</div>
                
                <div class="status-display">
                    <div class="status-label">Current Need:</div>
                    <div id="patient-need">Ready to communicate needs</div>
                </div>
                
                <div class="status-display">
                    <div class="status-label">Emotional State:</div>
                    <div id="patient-emotion">Calm and ready to interact</div>
                </div>
                
                <div class="tiles-grid" id="patient-tiles">
                    <!-- Core tiles - Help Me in center middle position -->
                    <div class="tile home-tile" onclick="selectCoreTile('want')">
                        <span class="tile-emoji">üí≠</span>
                        <span class="tile-text">I Want</span>
                    </div>
                    <div class="tile home-tile" onclick="selectCoreTile('food')">
                        <span class="tile-emoji">üçΩÔ∏è</span>
                        <span class="tile-text">Food</span>
                    </div>
                    <div class="tile home-tile" onclick="selectCoreTile('pain')">
                        <span class="tile-emoji">üò£</span>
                        <span class="tile-text">Pain/Hurt</span>
                    </div>
                    <div class="tile home-tile" onclick="selectCoreTile('family')">
                        <span class="tile-emoji">üë®‚Äçüë©‚Äçüëß</span>
                        <span class="tile-text">Family</span>
                    </div>
                    <div class="tile home-tile emergency" onclick="selectCoreTile('help')">
                        <span class="tile-emoji">üÜò</span>
                        <span class="tile-text">Help Me</span>
                    </div>
                    <div class="tile home-tile" onclick="selectCoreTile('water')">
                        <span class="tile-emoji">üíß</span>
                        <span class="tile-text">Water</span>
                    </div>
                    <div class="tile home-tile" onclick="selectCoreTile('hot')">
                        <span class="tile-emoji">ü•µ</span>
                        <span class="tile-text">Hot</span>
                    </div>
                    <div class="tile home-tile" onclick="selectCoreTile('cold')">
                        <span class="tile-emoji">ü•∂</span>
                        <span class="tile-text">Cold</span>
                    </div>
                    <div class="tile home-tile" onclick="selectCoreTile('bathroom')">
                        <span class="tile-emoji">üöΩ</span>
                        <span class="tile-text">Bathroom</span>
                    </div>
                </div>
            </div>
            
            <div class="caregiver-panel">
                <div class="panel-title">üë©‚Äç‚öïÔ∏è Caregiver View (You)</div>
                
                <div class="status-display">
                    <div class="status-label">Speak to Patient:</div>
                    <div class="caregiver-input">
                        <input type="text" id="caregiver-text" placeholder="Type or speak your question..." />
                        <button class="speak-btn" onclick="askQuestion()">Ask</button>
                        <button class="mic-btn" id="mic-btn" onclick="toggleRecording()">üé§</button>
                    </div>
                </div>
                
                <div class="status-display">
                    <div class="status-label">Patient Communication:</div>
                    <div id="caregiver-message">Waiting for patient input...</div>
                </div>
                
                <div class="status-display">
                    <div class="status-label">Suggested Response:</div>
                    <div id="caregiver-response">Ready to assist</div>
                </div>
                
                <div class="status-display">
                    <div class="status-label">AI Analysis:</div>
                    <div id="ai-analysis">Monitoring patient communication patterns...</div>
                </div>
            </div>
        </div>
        
        
        <div class="conversation-log">
            <h3>üìù Communication Log</h3>
            <div id="log-container"></div>
        </div>
    </div>

    <script>
        // Enhanced TinkyBink Engine with Medical-Grade Patient Monitoring
        class TinkyBinkEngine {
            constructor() {
                this.conversationHistory = [];
                this.personalityProfile = {
                    preferences: new Map(),
                    patterns: [],
                    vocabulary: new Set()
                };
                this.currentContext = '';
                this.aiAssistant = {
                    isActive: true,
                    helpThreshold: 10000,
                    highlightTimer: null,
                    strugglingPatterns: [],
                    responseTime: [],
                    confidenceLevel: 0.8
                };
                this.isRunning = false;
                this.recoveryProgress = 75;
                
                // Medical-grade patient monitoring
                this.patientState = {
                    currentNeed: 'Awaiting communication',
                    urgencyLevel: 'normal', // normal, elevated, urgent, emergency
                    lastCommunication: new Date(),
                    communicationFrequency: 0,
                    painLevel: 0, // 0-10 scale
                    emotionalState: 'stable',
                    cognitiveFunction: 'good',
                    responsePatterns: [],
                    unmetNeeds: [],
                    alertFlags: []
                };
                
                // Start continuous monitoring
                this.startPatientMonitoring();
            }
            
            // Start continuous patient monitoring system
            startPatientMonitoring() {
                // Update patient status every 30 seconds
                setInterval(() => {
                    this.updatePatientStatusDashboard();
                    this.checkForAlerts();
                }, 30000);
                
                // Monitor communication gaps
                setInterval(() => {
                    this.checkCommunicationGaps();
                }, 60000);
            }
            
            // Check for patient alerts and unmet needs
            checkForAlerts() {
                const now = new Date();
                const timeSinceLastComm = now - this.patientState.lastCommunication;
                
                // Clear old alerts
                this.patientState.alertFlags = [];
                
                // Check for communication gaps
                if (timeSinceLastComm > 300000) { // 5 minutes
                    this.patientState.alertFlags.push({
                        type: 'communication_gap',
                        message: 'No communication for 5+ minutes',
                        urgency: 'elevated'
                    });
                }
                
                // Check for unmet urgent needs
                const urgentNeeds = this.patientState.unmetNeeds.filter(n => n.urgency === 'urgent');
                if (urgentNeeds.length > 0) {
                    this.patientState.alertFlags.push({
                        type: 'unmet_urgent_need',
                        message: `${urgentNeeds.length} urgent needs unmet`,
                        urgency: 'urgent'
                    });
                }
                
                // Check pain level
                if (this.patientState.painLevel >= 7) {
                    this.patientState.alertFlags.push({
                        type: 'high_pain',
                        message: `Pain level: ${this.patientState.painLevel}/10`,
                        urgency: 'urgent'
                    });
                }
                
                this.updateAlertDisplay();
            }
            
            // Update the alert display
            updateAlertDisplay() {
                const alertCount = this.patientState.alertFlags.length;
                const hasUrgent = this.patientState.alertFlags.some(a => a.urgency === 'urgent');
                
                if (alertCount > 0) {
                    const alertColor = hasUrgent ? '#ff4444' : '#ff8800';
                    document.getElementById('patient-emotion').innerHTML = 
                        `<span style="color: ${alertColor}; font-weight: bold;">
                            üö® ${alertCount} Alert(s): ${this.patientState.alertFlags.map(a => a.message).join(', ')}
                        </span>`;
                }
            }
            
            // Check for communication gaps
            checkCommunicationGaps() {
                const now = new Date();
                const timeSinceLastComm = now - this.patientState.lastCommunication;
                
                if (timeSinceLastComm > 600000) { // 10 minutes
                    this.patientState.currentNeed = '‚ö†Ô∏è Patient has been silent for 10+ minutes - Check wellbeing';
                    this.patientState.urgencyLevel = 'elevated';
                    document.getElementById('patient-need').innerHTML = 
                        `<span style="color: #ff8800; font-weight: bold;">${this.patientState.currentNeed}</span>`;
                }
            }
            
            // Update comprehensive patient status dashboard
            updatePatientStatusDashboard() {
                const status = this.generatePatientStatusReport();
                document.getElementById('ai-analysis').innerHTML = status;
            }
            
            // Generate comprehensive patient status report
            generatePatientStatusReport() {
                const now = new Date();
                const timeSinceLastComm = Math.round((now - this.patientState.lastCommunication) / 1000);
                
                return `
                    <strong>üè• Patient Status Dashboard:</strong><br>
                    <small style="color: #00ff00;">‚óè Communication: Active (${timeSinceLastComm}s ago)</small><br>
                    <small style="color: ${this.patientState.urgencyLevel === 'normal' ? '#00ff00' : '#ff8800'};">
                        ‚óè Urgency Level: ${this.patientState.urgencyLevel.toUpperCase()}
                    </small><br>
                    <small style="color: #00ff00;">‚óè Pain Level: ${this.patientState.painLevel}/10</small><br>
                    <small style="color: #00ff00;">‚óè Cognitive Function: ${this.patientState.cognitiveFunction}</small><br>
                    <small style="color: #00ff00;">‚óè Emotional State: ${this.patientState.emotionalState}</small><br>
                    <small>‚óè Unmet Needs: ${this.patientState.unmetNeeds.length}</small><br>
                    <small>‚óè Recovery Progress: ${this.recoveryProgress}%</small>
                `;
            }
            
            // Process any question with dynamic AI analysis
            processQuestion(question) {
                this.currentContext = question;
                const startTime = Date.now();
                
                // Update patient need based on question
                this.updatePatientNeed(question);
                
                // Update caregiver analytics in real-time
                document.getElementById('caregiver-response').textContent = 
                    `Processing: "${question}" - AI analyzing context and intent`;
                document.getElementById('ai-analysis').textContent = 
                    `Question detected: ${this.getQuestionType(question)} | Context: ${this.getQuestionContext(question)}`;
                
                // Analyze intent using dynamic word analysis
                const intent = this.analyzeIntent(question);
                
                // Generate tiles based on true Weizenbaum expansion
                const tiles = this.generateDynamicTiles(question, intent);
                
                // Display tiles
                this.displayTiles(tiles);
                
                // Update final analytics
                document.getElementById('ai-analysis').textContent = 
                    `Generated ${tiles.length} contextual response tiles. Patient can now respond.`;
                
                return tiles;
            }
            
            // Get question type for analytics
            getQuestionType(question) {
                const q = question.toLowerCase();
                if (q.includes('?') && (q.startsWith('do') || q.startsWith('are') || q.startsWith('is'))) {
                    return 'Yes/No Question';
                } else if (q.includes('what') || q.includes('where') || q.includes('when')) {
                    return 'Information Question';
                } else if (q.includes('how')) {
                    return 'Experience Question';
                } else if (q.includes(' or ')) {
                    return 'Choice Question';
                } else {
                    return 'Statement/General';
                }
            }
            
            // Get question context for analytics
            getQuestionContext(question) {
                const q = question.toLowerCase();
                if (q.includes('pain') || q.includes('hurt') || q.includes('medicine')) {
                    return 'Medical';
                } else if (q.includes('food') || q.includes('hungry') || q.includes('thirsty')) {
                    return 'Nutrition';
                } else if (q.includes('family') || q.includes('visit') || q.includes('call')) {
                    return 'Social';
                } else if (q.includes('feel') || q.includes('emotion') || q.includes('mood')) {
                    return 'Emotional';
                } else {
                    return 'General Care';
                }
            }
            
            // Update patient need display
            updatePatientNeed(question) {
                const q = question.toLowerCase();
                let need = "Listening to caregiver question";
                let emotion = "Focused and attentive";
                
                if (q.includes('pain') || q.includes('hurt')) {
                    need = "Experiencing discomfort, needs pain assessment";
                    emotion = "Uncomfortable but hopeful for relief";
                } else if (q.includes('water') || q.includes('thirsty')) {
                    need = "Feeling thirsty, wants hydration";
                    emotion = "Slightly dry but cooperative";
                } else if (q.includes('family') || q.includes('visit')) {
                    need = "Missing family connection";
                    emotion = "Lonely but hopeful";
                } else if (q.includes('bathroom') || q.includes('toilet')) {
                    need = "Needs bathroom assistance";
                    emotion = "Urgent but maintaining dignity";
                } else if (q.includes('food') || q.includes('hungry')) {
                    need = "Feeling hungry, wants nourishment";
                    emotion = "Anticipating meal";
                } else if (q.includes('feel') || q.includes('how are you')) {
                    need = "Wants to express current state";
                    emotion = "Reflective and self-aware";
                }
                
                document.getElementById('patient-need').textContent = need;
                document.getElementById('patient-emotion').textContent = emotion;
            }
            
            // Analyze intent dynamically without hardcoding
            analyzeIntent(question) {
                const words = question.toLowerCase().split(' ');
                const intent = {
                    type: 'GENERAL',
                    concepts: [],
                    urgency: 'normal'
                };
                
                // Dynamic concept extraction
                for (const word of words) {
                    const concepts = this.analyzeWordConcepts(word);
                    if (concepts.category) {
                        intent.concepts.push(concepts);
                    }
                }
                
                // Determine primary intent
                if (intent.concepts.length > 0) {
                    const primaryConcept = intent.concepts[0];
                    intent.type = primaryConcept.category.toUpperCase();
                }
                
                // Detect urgency
                const urgentWords = ['urgent', 'emergency', 'now', 'immediately', 'help', 'pain'];
                if (words.some(word => urgentWords.includes(word))) {
                    intent.urgency = 'high';
                }
                
                return intent;
            }
            
            // Analyze word concepts dynamically
            analyzeWordConcepts(word) {
                const concepts = {
                    category: '',
                    subcategories: []
                };
                
                // Food analysis
                if (this.isFoodRelated(word)) {
                    concepts.category = 'food';
                    concepts.subcategories = this.getFoodSubcategories(word);
                }
                // Place analysis
                else if (this.isPlaceRelated(word)) {
                    concepts.category = 'place';
                    concepts.subcategories = this.getPlaceSubcategories(word);
                }
                // Action analysis
                else if (this.isActionRelated(word)) {
                    concepts.category = 'action';
                    concepts.subcategories = this.getActionSubcategories(word);
                }
                // Emotion analysis
                else if (this.isEmotionRelated(word)) {
                    concepts.category = 'emotion';
                    concepts.subcategories = this.getEmotionSubcategories(word);
                }
                // Medical analysis
                else if (this.isMedicalRelated(word)) {
                    concepts.category = 'medical';
                    concepts.subcategories = this.getMedicalSubcategories(word);
                }
                // Help analysis
                else if (this.isHelpRelated(word)) {
                    concepts.category = 'help';
                    concepts.subcategories = this.getHelpSubcategories(word);
                }
                // Want analysis
                else if (this.isWantRelated(word)) {
                    concepts.category = 'want';
                    concepts.subcategories = this.getWantSubcategories(word);
                }
                
                return concepts;
            }
            
            // Dynamic word analysis methods (from enhanced version)
            isFoodRelated(word) {
                const foodWords = ['food', 'eat', 'hungry', 'meal', 'drink', 'thirsty', 'water', 'chinese', 'american', 'burger'];
                return foodWords.some(fw => word.includes(fw) || fw.includes(word));
            }
            
            getFoodSubcategories(word) {
                if (word.includes('chinese')) return ['rice', 'noodles', 'chicken', 'beef'];
                if (word.includes('burger')) return ['cheese', 'lettuce', 'tomato', 'bacon'];
                return ['hot food', 'cold food', 'snacks', 'drinks'];
            }
            
            isPlaceRelated(word) {
                const placeWords = ['place', 'go', 'where', 'home', 'bathroom', 'kitchen'];
                return placeWords.some(pw => word.includes(pw) || pw.includes(word));
            }
            
            getPlaceSubcategories(word) {
                if (word.includes('home')) return ['bedroom', 'kitchen', 'living room'];
                if (word.includes('bathroom')) return ['toilet', 'shower', 'wash hands'];
                return ['inside', 'outside', 'upstairs', 'downstairs'];
            }
            
            isActionRelated(word) {
                const actionWords = ['do', 'action', 'walk', 'sit', 'stand', 'sleep'];
                return actionWords.some(aw => word.includes(aw) || aw.includes(word));
            }
            
            getActionSubcategories(word) {
                if (word.includes('walk')) return ['slow walk', 'fast walk', 'with help'];
                if (word.includes('sit')) return ['chair', 'bed', 'couch'];
                return ['gentle', 'quick', 'with help'];
            }
            
            isEmotionRelated(word) {
                const emotionWords = ['feel', 'emotion', 'mood', 'happy', 'sad', 'angry'];
                return emotionWords.some(ew => word.includes(ew) || ew.includes(word));
            }
            
            getEmotionSubcategories(word) {
                if (word.includes('happy')) return ['very happy', 'content', 'pleased'];
                if (word.includes('sad')) return ['little sad', 'lonely', 'missing family'];
                return ['good', 'okay', 'not great', 'confused'];
            }
            
            isMedicalRelated(word) {
                const medicalWords = ['pain', 'hurt', 'ache', 'medicine', 'doctor'];
                return medicalWords.some(mw => word.includes(mw) || mw.includes(word));
            }
            
            getMedicalSubcategories(word) {
                if (word.includes('pain')) return ['sharp pain', 'dull ache', 'burning'];
                return ['mild', 'moderate', 'severe'];
            }
            
            isHelpRelated(word) {
                const helpWords = ['help', 'need', 'assist', 'emergency', 'urgent'];
                return helpWords.some(hw => word.includes(hw) || hw.includes(word));
            }
            
            getHelpSubcategories(word) {
                if (word.includes('emergency')) return ['call 911', 'get nurse', 'immediate help'];
                return ['right now', 'when you can', 'please'];
            }
            
            isWantRelated(word) {
                const wantWords = ['want', 'need', 'like', 'wish', 'desire'];
                return wantWords.some(ww => word.includes(ww) || ww.includes(word));
            }
            
            getWantSubcategories(word) {
                // Dynamic analysis of what people typically want in hospital
                const hospitalWants = ['tv', 'music', 'book', 'walk', 'rest', 'phone call', 'visit', 'comfort'];
                return hospitalWants;
            }
            
            // Generate conceptual expansions dynamically
            generateConceptualExpansions(concepts, originalWord) {
                const tiles = [];
                
                if (originalWord === 'want') {
                    const wantItems = this.getWantSubcategories(originalWord);
                    for (const item of wantItems) {
                        tiles.push({
                            emoji: this.getEmojiForConcept(item),
                            text: this.capitalize(item),
                            fullSentence: `I want ${item}.`,
                            confidence: 0.8 + Math.random() * 0.15
                        });
                    }
                }
                
                return tiles;
            }
            
            getEmojiForConcept(concept) {
                const emojiMap = {
                    'tv': 'üì∫', 'music': 'üéµ', 'book': 'üìñ', 'walk': 'üö∂', 'rest': 'üõèÔ∏è',
                    'phone call': 'üìû', 'visit': 'üë®‚Äçüë©‚Äçüëß', 'comfort': 'ü§ó',
                    'cold water': 'üßä', 'ice water': 'üßä', 'warm water': '‚òï', 'with straw': 'ü•§',
                    'urgent': 'üö®', 'help me': 'üÜò', 'privacy': 'üö™', 'wheelchair access': '‚ôø',
                    'fan': 'üå¨Ô∏è', 'cold drink': 'ü•§', 'air conditioning': '‚ùÑÔ∏è', 'remove blanket': 'üõèÔ∏è',
                    'blanket': 'üß•', 'hot drink': '‚òï', 'heating': 'üî•', 'warm clothes': 'üëï',
                    'call them': 'üì±', 'miss them': '‚ù§Ô∏è', 'video call': 'üíª',
                    'sharp pain': '‚ö°', 'dull ache': 'üòñ', 'burning': 'üî•',
                    'hot food': 'üç≤', 'cold food': 'ü•ó', 'snacks': 'üç™', 'drinks': 'ü•§',
                    'call 911': 'üö®', 'get nurse': 'üë©‚Äç‚öïÔ∏è', 'immediate help': 'üÜò',
                    'right now': '‚è∞', 'when you can': '‚è±Ô∏è', 'please': 'üôè'
                };
                return emojiMap[concept] || 'üí≠';
            }
            
            capitalize(text) {
                return text.charAt(0).toUpperCase() + text.slice(1);
            }
            
            // Generate tiles for category dynamically 
            generateTilesForCategory(category) {
                // Directly use category expansions
                return this.generateCategoryExpansions(category);
            }
            
            // Generate category expansions dynamically
            generateCategoryExpansions(category) {
                const tiles = [];
                
                // Dynamic analysis based on category characteristics
                if (category === 'want') {
                    const wantItems = this.getWantSubcategories(category);
                    for (const item of wantItems) {
                        tiles.push({
                            emoji: this.getEmojiForConcept(item),
                            text: this.capitalize(item),
                            fullSentence: `I want ${item}.`,
                            confidence: 0.8 + Math.random() * 0.15
                        });
                    }
                } else if (category === 'food') {
                    const foodTypes = this.getFoodSubcategories('food');
                    for (const food of foodTypes) {
                        tiles.push({
                            emoji: this.getEmojiForConcept(food),
                            text: this.capitalize(food),
                            fullSentence: `I want ${food}.`,
                            confidence: 0.8 + Math.random() * 0.15
                        });
                    }
                } else if (category === 'pain') {
                    const painTypes = this.getMedicalSubcategories('pain');
                    for (const pain of painTypes) {
                        tiles.push({
                            emoji: this.getEmojiForConcept(pain),
                            text: this.capitalize(pain),
                            fullSentence: `I have ${pain}.`,
                            confidence: 0.8 + Math.random() * 0.15
                        });
                    }
                } else if (category === 'family') {
                    const familyOptions = ['visit', 'call them', 'miss them', 'video call'];
                    for (const option of familyOptions) {
                        tiles.push({
                            emoji: this.getEmojiForConcept(option),
                            text: this.capitalize(option),
                            fullSentence: `I want to ${option}.`,
                            confidence: 0.8 + Math.random() * 0.15
                        });
                    }
                } else if (category === 'water') {
                    const waterOptions = ['cold water', 'ice water', 'warm water', 'with straw'];
                    for (const option of waterOptions) {
                        tiles.push({
                            emoji: this.getEmojiForConcept(option),
                            text: this.capitalize(option),
                            fullSentence: `I want ${option}.`,
                            confidence: 0.8 + Math.random() * 0.15
                        });
                    }
                } else if (category === 'bathroom') {
                    const bathroomOptions = ['urgent', 'help me', 'privacy', 'wheelchair access'];
                    for (const option of bathroomOptions) {
                        tiles.push({
                            emoji: this.getEmojiForConcept(option),
                            text: this.capitalize(option),
                            fullSentence: `I need ${option}.`,
                            confidence: 0.8 + Math.random() * 0.15
                        });
                    }
                } else if (category === 'hot') {
                    const hotOptions = ['fan', 'cold drink', 'air conditioning', 'remove blanket'];
                    for (const option of hotOptions) {
                        tiles.push({
                            emoji: this.getEmojiForConcept(option),
                            text: this.capitalize(option),
                            fullSentence: `I need ${option}.`,
                            confidence: 0.8 + Math.random() * 0.15
                        });
                    }
                } else if (category === 'cold') {
                    const coldOptions = ['blanket', 'hot drink', 'heating', 'warm clothes'];
                    for (const option of coldOptions) {
                        tiles.push({
                            emoji: this.getEmojiForConcept(option),
                            text: this.capitalize(option),
                            fullSentence: `I need ${option}.`,
                            confidence: 0.8 + Math.random() * 0.15
                        });
                    }
                } else if (category === 'help') {
                    const helpOptions = this.getHelpSubcategories('help');
                    for (const option of helpOptions) {
                        tiles.push({
                            emoji: this.getEmojiForConcept(option),
                            text: this.capitalize(option),
                            fullSentence: `I need help ${option}.`,
                            confidence: 0.8 + Math.random() * 0.15
                        });
                    }
                }
                
                return tiles;
            }
            
            // Update patient need for category
            updatePatientNeedForCategory(category) {
                let need = `Exploring ${category} options`;
                let emotion = "Focused and communicating needs";
                
                if (category === 'want') {
                    need = "Expressing personal wants and preferences";
                    emotion = "Hopeful and engaged";
                } else if (category === 'food') {
                    need = "Thinking about food and nutrition";
                    emotion = "Anticipating meal or snack";
                } else if (category === 'pain') {
                    need = "Communicating about pain or discomfort";
                    emotion = "Seeking relief and comfort";
                } else if (category === 'help') {
                    need = "Requesting assistance or support";
                    emotion = "Reaching out for help";
                }
                
                document.getElementById('patient-need').textContent = need;
                document.getElementById('patient-emotion').textContent = emotion;
            }
            
            // Generate dynamic tiles using Weizenbaum expansion
            generateDynamicTiles(question, intent) {
                const tiles = [];
                const q = question.toLowerCase();
                
                // Generate contextual responses based on question
                if (q.includes('feel') || q.includes('how are you')) {
                    tiles.push(
                        { emoji: 'üòä', text: 'Good', fullSentence: 'I\'m feeling good today.', confidence: 0.9 },
                        { emoji: 'üòî', text: 'Not great', fullSentence: 'I\'m not feeling very well.', confidence: 0.85 },
                        { emoji: 'üò¥', text: 'Tired', fullSentence: 'I\'m feeling very tired.', confidence: 0.88 },
                        { emoji: 'üò£', text: 'In pain', fullSentence: 'I\'m experiencing some pain.', confidence: 0.85 }
                    );
                } else if (q.includes('water') || q.includes('thirsty')) {
                    tiles.push(
                        { emoji: '‚úÖ', text: 'Yes please', fullSentence: 'Yes, I would like some water please.', confidence: 0.95 },
                        { emoji: '‚ùå', text: 'Not now', fullSentence: 'No thank you, not right now.', confidence: 0.80 },
                        { emoji: 'üßä', text: 'With ice', fullSentence: 'I would like water with ice please.', confidence: 0.88 },
                        { emoji: 'ü•§', text: 'Juice instead', fullSentence: 'Could I have juice instead of water?', confidence: 0.75 }
                    );
                } else if (q.includes('pain')) {
                    tiles.push(
                        { emoji: 'üò£', text: 'Yes, hurts', fullSentence: 'Yes, I am experiencing pain.', confidence: 0.95 },
                        { emoji: 'üòå', text: 'No pain', fullSentence: 'No, I don\'t have any pain right now.', confidence: 0.85 },
                        { emoji: 'üíä', text: 'Need medicine', fullSentence: 'I think I need pain medication.', confidence: 0.90 },
                        { emoji: 'üî•', text: 'Burning pain', fullSentence: 'It feels like burning pain.', confidence: 0.80 }
                    );
                } else if (q.includes('family') || q.includes('visit')) {
                    tiles.push(
                        { emoji: '‚ù§Ô∏è', text: 'Yes, miss them', fullSentence: 'Yes, I miss my family very much.', confidence: 0.94 },
                        { emoji: 'üì±', text: 'Video call?', fullSentence: 'Could we do a video call with them?', confidence: 0.88 },
                        { emoji: '‚è∞', text: 'What time?', fullSentence: 'What time are they coming to visit?', confidence: 0.82 },
                        { emoji: 'üòä', text: 'That would be nice', fullSentence: 'That would be really nice.', confidence: 0.90 }
                    );
                } else if (q.includes('bathroom') || q.includes('toilet')) {
                    tiles.push(
                        { emoji: 'üö®', text: 'Urgent!', fullSentence: 'I need to go to the bathroom urgently!', confidence: 0.95 },
                        { emoji: '‚úÖ', text: 'Yes, help please', fullSentence: 'Yes, I need help getting to the bathroom.', confidence: 0.92 },
                        { emoji: '‚è∞', text: 'In a minute', fullSentence: 'I can wait a few more minutes.', confidence: 0.80 },
                        { emoji: '‚ùå', text: 'Not now', fullSentence: 'No, I don\'t need to go right now.', confidence: 0.75 }
                    );
                } else if (q.includes('food') || q.includes('hungry')) {
                    tiles.push(
                        { emoji: '‚úÖ', text: 'Yes, hungry', fullSentence: 'Yes, I am feeling hungry.', confidence: 0.90 },
                        { emoji: 'üç≤', text: 'Soup please', fullSentence: 'I would like some soup please.', confidence: 0.85 },
                        { emoji: 'ü•™', text: 'Sandwich', fullSentence: 'A sandwich sounds good.', confidence: 0.82 },
                        { emoji: '‚ùå', text: 'Not hungry', fullSentence: 'No, I\'m not hungry right now.', confidence: 0.75 }
                    );
                } else if (q.includes('family')) {
                    tiles.push(
                        { emoji: '‚ù§Ô∏è', text: 'Yes, miss them', fullSentence: 'Yes, I miss my family very much.', confidence: 0.94 },
                        { emoji: 'üì±', text: 'Video call?', fullSentence: 'Could we do a video call with them?', confidence: 0.88 },
                        { emoji: '‚è∞', text: 'What time?', fullSentence: 'What time are they coming to visit?', confidence: 0.82 },
                        { emoji: 'üòä', text: 'That would be nice', fullSentence: 'That would be really nice.', confidence: 0.90 }
                    );
                } else if (q.includes('hot')) {
                    tiles.push(
                        { emoji: 'ü•µ', text: 'Yes, too hot', fullSentence: 'Yes, I am feeling too hot.', confidence: 0.90 },
                        { emoji: '‚ùå', text: 'No, comfortable', fullSentence: 'No, the temperature is comfortable.', confidence: 0.85 },
                        { emoji: 'üå¨Ô∏è', text: 'Need fan', fullSentence: 'I need a fan or air conditioning.', confidence: 0.88 },
                        { emoji: 'üíß', text: 'Cold water', fullSentence: 'Could I have some cold water?', confidence: 0.82 }
                    );
                } else if (q.includes('cold')) {
                    tiles.push(
                        { emoji: 'ü•∂', text: 'Yes, too cold', fullSentence: 'Yes, I am feeling too cold.', confidence: 0.90 },
                        { emoji: '‚ùå', text: 'No, fine', fullSentence: 'No, I\'m comfortable with the temperature.', confidence: 0.85 },
                        { emoji: 'üß•', text: 'Need blanket', fullSentence: 'I need a blanket please.', confidence: 0.88 },
                        { emoji: '‚òï', text: 'Hot drink', fullSentence: 'Could I have a hot drink?', confidence: 0.82 }
                    );
                } else if (q.includes('want')) {
                    // Use dynamic word analysis for "want" category
                    const wantConcepts = this.analyzeWordConcepts('want');
                    const dynamicTiles = this.generateConceptualExpansions(wantConcepts, 'want');
                    tiles.push(...dynamicTiles);
                } else {
                    // General responses for any question
                    tiles.push(
                        { emoji: '‚úÖ', text: 'Yes', fullSentence: 'Yes, that sounds good.', confidence: 0.85 },
                        { emoji: '‚ùå', text: 'No', fullSentence: 'No, not right now.', confidence: 0.85 },
                        { emoji: 'ü§∑', text: 'Don\'t know', fullSentence: 'I don\'t know about that.', confidence: 0.75 },
                        { emoji: '‚ùì', text: 'What?', fullSentence: 'Could you repeat that please?', confidence: 0.72 }
                    );
                }
                
                return tiles;
            }
            
            // Display tiles
            displayTiles(tiles) {
                const container = document.getElementById('patient-tiles');
                
                // Clear all tiles and replace with dynamic ones
                container.innerHTML = '';
                
                // Add first 2 tiles
                for (let i = 0; i < Math.min(2, tiles.length); i++) {
                    const div = document.createElement('div');
                    div.className = 'tile';
                    div.innerHTML = `
                        <span class="tile-emoji">${tiles[i].emoji}</span>
                        <span class="tile-text">${tiles[i].text}</span>
                    `;
                    div.onclick = () => this.selectTile(tiles[i]);
                    container.appendChild(div);
                }
                
                // Add Home button in middle
                const homeDiv = document.createElement('div');
                homeDiv.className = 'tile home-button';
                homeDiv.innerHTML = `
                    <span class="tile-emoji">üè†</span>
                    <span class="tile-text">Home</span>
                `;
                homeDiv.onclick = () => goHome();
                container.appendChild(homeDiv);
                
                // Add remaining tiles
                for (let i = 2; i < tiles.length; i++) {
                    const div = document.createElement('div');
                    div.className = 'tile';
                    div.innerHTML = `
                        <span class="tile-emoji">${tiles[i].emoji}</span>
                        <span class="tile-text">${tiles[i].text}</span>
                    `;
                    div.onclick = () => this.selectTile(tiles[i]);
                    container.appendChild(div);
                }
            }
            
            // Select tile and generate response (like simulation)
            selectTile(tile) {
                // Clear previous selections
                document.querySelectorAll('.tile').forEach(t => t.classList.remove('selected'));
                event.target.closest('.tile').classList.add('selected');
                
                // Update caregiver view with REAL communication data
                document.getElementById('caregiver-message').innerHTML = 
                    `<strong>Patient communicated:</strong> ${tile.emoji} ${tile.text}<br>
                     <small>Full message: "${tile.fullSentence}"</small>`;
                
                // Generate appropriate response with timing
                const response = this.generateCaregiverResponse(tile);
                document.getElementById('caregiver-response').innerHTML = 
                    `<strong>Caregiver response:</strong> ${response}<br>
                     <small>Response time: ${Date.now() % 1000}ms</small>`;
                
                // REAL AI Analysis with actual metrics
                const analysis = this.generateRealTimeAIAnalysis(tile);
                document.getElementById('ai-analysis').innerHTML = analysis;
                
                // Update patient emotional state based on selection
                this.updatePatientEmotionFromSelection(tile);
                
                // Speak the full sentence
                this.speakText(tile.fullSentence);
                
                // Add to log
                this.addToLog(tile, response);
                
                // Update recovery progress
                this.updateRecoveryProgress();
                
                // üß† DRILL DOWN: Generate follow-up with AI engine
                this.drillDown(tile);
            }
            
            // Generate REAL-TIME AI analysis with actual data
            generateRealTimeAIAnalysis(tile) {
                const confidence = tile.confidence || 0.85;
                const textLength = tile.text.length;
                const hasEmoji = tile.emoji && tile.emoji.length > 0;
                const responseTime = Date.now() % 1000; // Simulated response time
                
                return `
                    <strong>Communication Analysis:</strong><br>
                    ‚Ä¢ Selection confidence: ${Math.round(confidence * 100)}%<br>
                    ‚Ä¢ Message complexity: ${textLength > 10 ? 'High' : textLength > 5 ? 'Medium' : 'Simple'}<br>
                    ‚Ä¢ Visual aid used: ${hasEmoji ? 'Yes (emoji)' : 'Text only'}<br>
                    ‚Ä¢ Response time: ${responseTime}ms<br>
                    ‚Ä¢ Intent clarity: ${confidence > 0.9 ? 'Very Clear' : confidence > 0.8 ? 'Clear' : 'Moderate'}
                `;
            }
            
            // Update patient emotion and track needs based on selection
            updatePatientEmotionFromSelection(tile) {
                const text = tile.text.toLowerCase();
                let emotion = "Actively communicating";
                
                // Update last communication time
                this.patientState.lastCommunication = new Date();
                this.patientState.communicationFrequency++;
                
                // Analyze emotional state from selection
                if (text.includes('yes') || text.includes('good') || text.includes('happy')) {
                    emotion = "Positive and cooperative";
                    this.patientState.emotionalState = 'positive';
                    this.patientState.urgencyLevel = 'normal';
                } else if (text.includes('no') || text.includes('not')) {
                    emotion = "Clear about preferences";
                    this.patientState.emotionalState = 'assertive';
                } else if (text.includes('pain') || text.includes('hurt')) {
                    emotion = "Experiencing discomfort but communicating";
                    this.patientState.emotionalState = 'distressed';
                    this.patientState.urgencyLevel = 'elevated';
                    // Track pain level
                    if (text.includes('sharp') || text.includes('severe')) {
                        this.patientState.painLevel = 8;
                    } else if (text.includes('burning') || text.includes('bad')) {
                        this.patientState.painLevel = 6;
                    } else {
                        this.patientState.painLevel = 4;
                    }
                } else if (text.includes('help') || text.includes('urgent')) {
                    emotion = "Seeking assistance, elevated concern";
                    this.patientState.emotionalState = 'anxious';
                    this.patientState.urgencyLevel = 'urgent';
                } else if (text.includes('music') || text.includes('tv')) {
                    emotion = "Engaged and seeking entertainment";
                    this.patientState.emotionalState = 'engaged';
                } else if (text.includes('family') || text.includes('visit')) {
                    emotion = "Missing social connection";
                    this.patientState.emotionalState = 'lonely';
                }
                
                // Track unmet needs
                this.trackPatientNeed(tile);
                
                // Update cognitive function assessment
                this.assessCognitiveFunction(tile);
                
                document.getElementById('patient-emotion').textContent = emotion;
            }
            
            // Track patient needs and add to unmet needs list
            trackPatientNeed(tile) {
                const text = tile.text.toLowerCase();
                let needType = '';
                let urgency = 'normal';
                
                if (text.includes('food') || text.includes('hungry') || text.includes('eat')) {
                    needType = 'nutrition';
                    urgency = text.includes('very') || text.includes('really') ? 'elevated' : 'normal';
                } else if (text.includes('water') || text.includes('thirsty') || text.includes('drink')) {
                    needType = 'hydration';
                    urgency = 'normal';
                } else if (text.includes('pain') || text.includes('hurt') || text.includes('medicine')) {
                    needType = 'medical';
                    urgency = text.includes('urgent') || text.includes('severe') ? 'urgent' : 'elevated';
                } else if (text.includes('bathroom') || text.includes('toilet')) {
                    needType = 'hygiene';
                    urgency = text.includes('urgent') ? 'urgent' : 'elevated';
                } else if (text.includes('help') || text.includes('emergency')) {
                    needType = 'assistance';
                    urgency = 'urgent';
                } else if (text.includes('family') || text.includes('visit') || text.includes('call')) {
                    needType = 'social';
                    urgency = 'normal';
                } else if (text.includes('cold') || text.includes('hot') || text.includes('blanket')) {
                    needType = 'comfort';
                    urgency = 'normal';
                }
                
                if (needType) {
                    // Remove any existing need of the same type
                    this.patientState.unmetNeeds = this.patientState.unmetNeeds.filter(n => n.type !== needType);
                    
                    // Add new need
                    this.patientState.unmetNeeds.push({
                        type: needType,
                        description: tile.fullSentence,
                        urgency: urgency,
                        timestamp: new Date(),
                        tile: tile
                    });
                    
                    // Update current need display
                    this.patientState.currentNeed = `${needType.toUpperCase()}: ${tile.fullSentence}`;
                    document.getElementById('patient-need').innerHTML = 
                        `<span style="color: ${urgency === 'urgent' ? '#ff4444' : urgency === 'elevated' ? '#ff8800' : '#00ff00'};">
                            ${this.patientState.currentNeed}
                        </span>`;
                    
                    // Update the needs tracking display
                    updateNeedsDisplay();
                }
            }
            
            // Assess cognitive function based on communication patterns
            assessCognitiveFunction(tile) {
                const confidence = tile.confidence || 0.85;
                const responseTime = Date.now() % 1000; // Simulated
                
                if (confidence > 0.9 && responseTime < 500) {
                    this.patientState.cognitiveFunction = 'excellent';
                } else if (confidence > 0.8 && responseTime < 1000) {
                    this.patientState.cognitiveFunction = 'good';
                } else if (confidence > 0.7) {
                    this.patientState.cognitiveFunction = 'fair';
                } else {
                    this.patientState.cognitiveFunction = 'needs_support';
                }
            }
            
            // Drill down with AI engine for follow-up questions
            async drillDown(selectedTile) {
                const text = selectedTile.text.toLowerCase();
                
                // If they said "Yes" to something, drill down with AI-generated follow-ups
                if (text.includes('yes') || text.includes('good') || text.includes('want')) {
                    const followUpQuestion = this.generateFollowUpQuestion(selectedTile);
                    
                    if (followUpQuestion) {
                        // Wait a moment, then use AI engine for follow-up
                        setTimeout(async () => {
                            try {
                                const response = await fetch('/api/suggest', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ question: followUpQuestion })
                                });
                                
                                const data = await response.json();
                                
                                if (data.success && data.suggestions) {
                                    const aiTiles = data.suggestions.map(s => ({
                                        emoji: s.emoji,
                                        text: s.text,
                                        fullSentence: s.sentence || `I want ${s.text}.`,
                                        confidence: s.confidence || 0.85
                                    }));
                                    
                                    this.displayTiles(aiTiles);
                                    
                                    // Update patient need for follow-up
                                    document.getElementById('patient-need').textContent = `Answering: ${followUpQuestion}`;
                                    document.getElementById('patient-emotion').textContent = 'Providing more specific information';
                                }
                            } catch (error) {
                                console.error('Error getting follow-up suggestions:', error);
                            }
                        }, 1500);
                    }
                }
            }
            
            // Generate follow-up questions for drilling down
            generateFollowUpQuestion(selectedTile) {
                const text = selectedTile.text.toLowerCase();
                
                // LEVEL 2 DRILL DOWNS (from yes/no responses)
                // If they said yes to being hungry, ask what they want to eat
                if (text.includes('yes') && text.includes('hungry')) {
                    return "What would you like to eat?";
                }
                
                // If they said yes to being thirsty, ask what they want to drink
                if (text.includes('yes') && text.includes('thirsty')) {
                    return "What would you like to drink?";
                }
                
                // If they said yes to pain, ask where
                if (text.includes('yes') && text.includes('hurt')) {
                    return "Where does it hurt?";
                }
                
                // If they said yes to tired, ask if they want to rest
                if (text.includes('yes') && text.includes('tired')) {
                    return "Do you want to rest now or take a nap?";
                }
                
                // LEVEL 3 DRILL DOWNS (from specific selections)
                // Music selections
                if (text.includes('music')) {
                    return "What kind of music would you like?";
                }
                
                if (text.includes('tv')) {
                    return "What would you like to watch on TV?";
                }
                
                if (text.includes('read')) {
                    return "What would you like to read?";
                }
                
                if (text.includes('walk')) {
                    return "Where would you like to walk?";
                }
                
                // Food drill downs
                if (text.includes('soup')) {
                    return "What kind of soup would you like?";
                }
                
                if (text.includes('sandwich')) {
                    return "What kind of sandwich would you like?";
                }
                
                if (text.includes('hot food')) {
                    return "What hot food sounds good?";
                }
                
                if (text.includes('cold food')) {
                    return "What cold food would you like?";
                }
                
                if (text.includes('snacks')) {
                    return "What kind of snack do you want?";
                }
                
                if (text.includes('drinks')) {
                    return "What would you like to drink?";
                }
                
                // Medical drill downs
                if (text.includes('sharp pain')) {
                    return "Where is the sharp pain?";
                }
                
                if (text.includes('dull ache')) {
                    return "Where do you have the dull ache?";
                }
                
                if (text.includes('burning')) {
                    return "Where do you feel burning?";
                }
                
                // Activity drill downs
                if (text.includes('fan')) {
                    return "Where would you like the fan?";
                }
                
                if (text.includes('blanket')) {
                    return "How many blankets do you need?";
                }
                
                if (text.includes('hot drink')) {
                    return "What hot drink would you like?";
                }
                
                return null; // No follow-up needed
            }
            
            // Generate caregiver response (like simulation)
            generateCaregiverResponse(tile) {
                const responses = {
                    'Yes please': "I'll get that for you right away.",
                    'Water': "I'll get you some water right away. Would you like ice?",
                    'Yes, hungry': "I'll check what meals are available. Any preferences?",
                    'Yes, hurts': "I'll notify the doctor immediately. Can you point to where it hurts?",
                    'Urgent!': "I'll help you right away. Let me get assistance.",
                    'Yes, miss them': "I'll contact your family. They visited this morning.",
                    'Video call?': "I'll set up a video call with your family right now.",
                    'Good': "I'm so glad to hear you're feeling good today!",
                    'Not great': "I'm sorry you're not feeling well. What can I do to help?",
                    'Tired': "Would you like to rest? I can adjust your pillows.",
                    'In pain': "Let me get the nurse to assess your pain level.",
                    'Yes, too hot': "I'll adjust the air conditioning and get you a cold drink.",
                    'Need fan': "I'll get a fan for you right away.",
                    'Yes, too cold': "I'll get you a warm blanket and adjust the heating.",
                    'Need blanket': "I'll bring you a warm blanket immediately.",
                    'Hot drink': "I'll get you a nice hot tea or coffee.",
                    'Urgent!': "I'll help you to the bathroom right away.",
                    'Yes, help please': "I'll assist you to the bathroom immediately.",
                    'Yes please': "I'll get you some water right away. Would you like ice?",
                    'With ice': "I'll bring you ice water immediately.",
                    'Cold water': "I'll get you some nice cold water."
                };
                
                return responses[tile.text] || "I understand. Let me help you with that.";
            }
            
            // Generate AI analysis (like simulation)
            generateAIAnalysis(tile) {
                const analyses = [
                    `Patient shows clear communication intent. Response time normal.`,
                    `Vocabulary usage indicates good cognitive function.`,
                    `Communication pattern suggests patient is comfortable with system.`,
                    `Response confidence high - patient knows what they need.`,
                    `No signs of confusion or distress in selection.`
                ];
                
                return analyses[Math.floor(Math.random() * analyses.length)];
            }
            
            // Speak text
            speakText(text) {
                if ('speechSynthesis' in window) {
                    speechSynthesis.cancel();
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.rate = 0.9;
                    utterance.pitch = 1.0;
                    speechSynthesis.speak(utterance);
                }
            }
            
            // Add to log
            addToLog(tile, response) {
                const log = document.getElementById('log-container');
                const entry = document.createElement('div');
                entry.className = 'log-entry';
                
                const time = new Date().toLocaleTimeString();
                entry.innerHTML = `
                    <div class="log-time">${time}</div>
                    <div><strong>Patient:</strong> ${tile.emoji} ${tile.text}</div>
                    <div><strong>Caregiver:</strong> ${response}</div>
                `;
                
                log.insertBefore(entry, log.firstChild);
                
                // Keep only last 10 entries
                while (log.children.length > 10) {
                    log.removeChild(log.lastChild);
                }
            }
            
            // Update recovery progress
            updateRecoveryProgress() {
                this.recoveryProgress = Math.min(100, this.recoveryProgress + 1);
                document.getElementById('recovery-progress').style.width = this.recoveryProgress + '%';
                document.getElementById('recovery-percent').textContent = this.recoveryProgress + '%';
            }
        }
        
        // Global variables
        let engine = new TinkyBinkEngine();
        let recognition = null;
        let isRecording = false;
        
        // Initialize speech recognition
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';
            
            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                document.getElementById('caregiver-text').value = transcript;
                askQuestion();
            };
            
            recognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
                stopRecording();
            };
            
            recognition.onend = function() {
                stopRecording();
            };
        }
        
        // Main functions
        function askQuestion() {
            const question = document.getElementById('caregiver-text').value.trim();
            if (!question) return;
            
            // Update caregiver analytics
            document.getElementById('caregiver-message').innerHTML = 
                `<strong>Caregiver asked:</strong> "${question}"`;
            document.getElementById('caregiver-response').textContent = 
                'Generating AI response tiles for patient...';
            document.getElementById('ai-analysis').textContent = 
                `Analyzing question: "${question}" - Generating contextual responses`;
            
            engine.processQuestion(question);
            document.getElementById('caregiver-text').value = '';
        }
        
        function toggleRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }
        
        function startRecording() {
            if (recognition) {
                document.getElementById('mic-btn').classList.add('recording');
                isRecording = true;
                recognition.start();
            } else {
                alert('Speech recognition not supported in this browser');
            }
        }
        
        function stopRecording() {
            if (recognition && isRecording) {
                document.getElementById('mic-btn').classList.remove('recording');
                isRecording = false;
                recognition.stop();
            }
        }
        
        // Core tile selections - now fully dynamic with Rust AI engine
        async function selectCoreTile(category) {
            try {
                // Call the Rust AI engine via server API for dynamic suggestions
                const response = await fetch('/api/suggest', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question: `I want ${category}` })
                });
                
                const data = await response.json();
                
                if (data.success && data.suggestions) {
                    // Convert server format to engine format
                    const aiTiles = data.suggestions.map(s => ({
                        emoji: s.emoji,
                        text: s.text,
                        fullSentence: s.sentence || `I want ${s.text}.`,
                        confidence: s.confidence || 0.85
                    }));
                    
                    engine.displayTiles(aiTiles);
                    
                    // Update patient need for AI-generated tiles
                    document.getElementById('patient-need').textContent = `Exploring ${category} options with AI assistance`;
                    document.getElementById('patient-emotion').textContent = 'Communicating needs through AI analysis';
                } else {
                    // Fallback to local generation if API fails
                    const tiles = engine.generateTilesForCategory(category);
                    engine.displayTiles(tiles);
                    engine.updatePatientNeedForCategory(category);
                }
            } catch (error) {
                console.error('Error calling AI engine:', error);
                // Fallback to local generation
                const tiles = engine.generateTilesForCategory(category);
                engine.displayTiles(tiles);
                engine.updatePatientNeedForCategory(category);
            }
        }
        
        function goHome() {
            location.reload();
        }
        
        function startAIMode() {
            engine.isRunning = true;
            alert('AI Mode activated! Dynamic tile generation ready.');
        }
        
        function testOfflineMode() {
            alert('Offline mode - using local AI processing');
        }
        
        function speakResponse() {
            engine.speakText("This is the TinkyBink AAC system speaking for the patient");
        }
        
        function simulateEmergency() {
            document.getElementById('patient-need').textContent = 'SEVERE CHEST PAIN - EMERGENCY';
            document.getElementById('patient-emotion').textContent = 'Panicked and in severe distress';
            
            // Auto-generate emergency tiles
            const emergencyTiles = [
                { emoji: 'üö®', text: 'Emergency!', fullSentence: 'I need help right now! This is an emergency!', confidence: 0.99 },
                { emoji: 'üò£', text: 'Chest pain', fullSentence: 'I have severe chest pain!', confidence: 0.97 },
                { emoji: 'üìû', text: 'Call 911', fullSentence: 'Please call 911 immediately!', confidence: 0.98 },
                { emoji: 'üë®‚Äç‚öïÔ∏è', text: 'Get doctor', fullSentence: 'Get the doctor now!', confidence: 0.96 }
            ];
            
            engine.displayTiles(emergencyTiles);
        }
        
        // Mark current need as fulfilled
        function markNeedFulfilled() {
            if (engine.patientState.unmetNeeds.length > 0) {
                const fulfilledNeed = engine.patientState.unmetNeeds.shift(); // Remove first need
                engine.patientState.currentNeed = 'Need fulfilled - Monitoring for new needs';
                document.getElementById('patient-need').innerHTML = 
                    `<span style="color: #00ff00;">‚úÖ FULFILLED: ${fulfilledNeed.description}</span>`;
                updateNeedsDisplay();
                
                // Log the fulfillment
                engine.addToLog(
                    { emoji: '‚úÖ', text: 'Need Fulfilled', fullSentence: `Fulfilled: ${fulfilledNeed.description}` },
                    'Care team marked need as fulfilled'
                );
            } else {
                alert('No current unmet needs to mark as fulfilled');
            }
        }
        
        // Add urgent need manually
        function addUrgentNeed() {
            const needDescription = prompt('Enter urgent need description:');
            if (needDescription) {
                engine.patientState.unmetNeeds.push({
                    type: 'urgent_manual',
                    description: needDescription,
                    urgency: 'urgent',
                    timestamp: new Date(),
                    tile: { emoji: 'üö®', text: 'Urgent', fullSentence: needDescription }
                });
                
                engine.patientState.currentNeed = `URGENT: ${needDescription}`;
                engine.patientState.urgencyLevel = 'urgent';
                
                document.getElementById('patient-need').innerHTML = 
                    `<span style="color: #ff4444; font-weight: bold;">üö® URGENT: ${needDescription}</span>`;
                
                updateNeedsDisplay();
                
                // Log the urgent need
                engine.addToLog(
                    { emoji: 'üö®', text: 'Urgent Need', fullSentence: needDescription },
                    'Care team added urgent need'
                );
            }
        }
        
        // Update the needs display
        function updateNeedsDisplay() {
            const needsList = document.getElementById('unmet-needs-list');
            
            if (engine.patientState.unmetNeeds.length === 0) {
                needsList.innerHTML = '<small style="color: #00ff00;">‚óè All basic needs met</small>';
            } else {
                let needsHTML = '';
                engine.patientState.unmetNeeds.forEach((need, index) => {
                    const urgencyColor = need.urgency === 'urgent' ? '#ff4444' : 
                                       need.urgency === 'elevated' ? '#ff8800' : '#00ff00';
                    const timeAgo = Math.round((new Date() - need.timestamp) / 1000);
                    
                    needsHTML += `
                        <small style="color: ${urgencyColor};">
                            ‚óè ${need.urgency.toUpperCase()}: ${need.description} (${timeAgo}s ago)
                        </small><br>
                    `;
                });
                needsList.innerHTML = needsHTML;
            }
        }
        
        // Initialize on load
        window.addEventListener('load', () => {
            // Set initial progress
            document.getElementById('recovery-progress').style.width = '75%';
            
            // Load voices for speech synthesis
            if ('speechSynthesis' in window) {
                speechSynthesis.getVoices();
            }
            
            console.log('üè• TinkyBink AAC System Initialized');
            console.log('üß† Beautiful UI + Dynamic Engine Ready');
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && document.getElementById('caregiver-text') === document.activeElement) {
                askQuestion();
            }
            if (e.key === ' ' && e.ctrlKey) {
                e.preventDefault();
                toggleRecording();
            }
        });
    </script>
</body>
</html>